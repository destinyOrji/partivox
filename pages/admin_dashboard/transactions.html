<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="shortcut icon" href="../../images/IconDiamond.png" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="/css/enhanced-typography.css" rel="stylesheet">
  <style>
    :root {
      /* === PARTIVOX DESIGN SYSTEM === */
      
      /* Core Background Colors */
      --primary-bg: #0a0a0f;
      --secondary-bg: #1a1a1f;
      --card-bg: #1e1e24;
      --sidebar-bg: #16161b;
      --surface-bg: #252530;
      --overlay-bg: rgba(10, 10, 15, 0.95);
      
      /* Lemon Green Brand Colors (Primary) */
      --accent-color: #caf403; /* signature lemon green */
      --accent-hover: #9dcf00; /* darker lemon green */
      --accent-light: #e8ff4d; /* lighter lemon green */
      --accent-dark: #7ba800; /* darkest lemon green */
      --accent-rgb: 202, 244, 3;
      
      /* Secondary Brand Colors */
      --primary-color: #667eea;
      --primary-hover: #5a67d8;
      --primary-light: #7c3aed;
      --primary-rgb: 102, 126, 234;
      
      /* Text Colors */
      --text-primary: #ffffff;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --text-inverse: #000000;
      --text-accent: var(--accent-color);
      
      /* Status Colors */
      --success-color: #10b981;
      --success-light: #34d399;
      --warning-color: #f59e0b;
      --warning-light: #fbbf24;
      --danger-color: #ef4444;
      --danger-light: #f87171;
      --info-color: #3b82f6;
      --info-light: #60a5fa;
      
      /* Border & Divider Colors */
      --border-color: #27272a;
      --border-light: #374151;
      --border-accent: var(--accent-color);
      --divider-color: rgba(255, 255, 255, 0.1);
      
      /* Layout Variables */
      --sidebar-width: 280px;
      --sidebar-collapsed-width: 60px;
      --topbar-height: 70px;
      --border-radius: 12px;
      --border-radius-sm: 8px;
      --border-radius-lg: 16px;
      
      /* Spacing Scale */
      --space-xs: 0.25rem;    /* 4px */
      --space-sm: 0.5rem;     /* 8px */
      --space-md: 1rem;       /* 16px */
      --space-lg: 1.5rem;     /* 24px */
      --space-xl: 2rem;       /* 32px */
      --space-2xl: 3rem;      /* 48px */
      --space-3xl: 4rem;      /* 64px */
      
      /* Typography Scale */
      --text-xs: 0.75rem;     /* 12px */
      --text-sm: 0.875rem;    /* 14px */
      --text-base: 1rem;      /* 16px */
      --text-lg: 1.125rem;    /* 18px */
      --text-xl: 1.25rem;     /* 20px */
      --text-2xl: 1.5rem;     /* 24px */
      --text-3xl: 1.875rem;   /* 30px */
      --text-4xl: 2.25rem;    /* 36px */
      
      /* Animation & Transitions */
      --transition-fast: 0.15s ease;
      --transition-base: 0.2s ease;
      --transition-slow: 0.3s ease;
      --transition-bounce: 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      
      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-base: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
      --shadow-accent: 0 0 0 3px rgba(202, 244, 3, 0.15);
      
      /* Z-Index Scale */
      --z-dropdown: 1000;
      --z-sticky: 1020;
      --z-fixed: 1030;
      --z-modal-backdrop: 1040;
      --z-modal: 1050;
      --z-popover: 1060;
      --z-tooltip: 1070;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: linear-gradient(135deg, var(--primary-bg) 0%, #0f0f14 100%);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.6;
    }

    .sidebar {
      height: 100vh;
      background: linear-gradient(180deg, var(--sidebar-bg) 0%, #12121a 100%);
      border-right: 1px solid var(--border-color);
      position: fixed;
      width: 280px;
      z-index: 1000;
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
    }

    .sidebar.collapsed {
      transform: translateX(-240px);
      width: 60px;
    }

    .sidebar.collapsed .logo h4,
    .sidebar.collapsed .nav-section h6,
    .sidebar.collapsed a span {
      opacity: 0;
      visibility: hidden;
    }

    .sidebar .logo {
      padding: 2rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar .logo h4 {
      font-weight: 700;
      font-size: 1.5rem;
      background: linear-gradient(135deg, var(--accent-color), #9dcf00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .sidebar .nav-section {
      padding: 1rem 0;
    }

    .sidebar .nav-section h6 {
      color: var(--text-muted);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0 1.5rem;
      margin-bottom: 0.5rem;
    }

    .sidebar a {
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      padding: 0.75rem 1.5rem;
      text-decoration: none;
      transition: all 0.2s ease;
      position: relative;
    }

    .sidebar a i {
      width: 20px;
      margin-right: 12px;
      font-size: 1rem;
    }

    .sidebar a:hover {
      background: rgba(202, 244, 3, 0.1);
      color: var(--text-primary);
      transform: translateX(4px);
    }

    .sidebar a.active {
      background: linear-gradient(90deg, var(--accent-color), transparent);
      color: var(--text-primary);
      border-right: 3px solid var(--accent-color);
    }

    .sidebar a.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--accent-color);
    }

    .main-content {
      margin-left: 280px;
      min-height: 100vh;
      transition: margin-left 0.3s ease;
    }

    .main-content.sidebar-collapsed {
      margin-left: 60px;
    }

    .sidebar-toggle {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-secondary);
    }

    .sidebar-toggle:hover {
      background: var(--accent-color);
      color: #000;
      transform: scale(1.05);
    }

    .content {
      padding: 2rem;
      background: transparent;
    }

    .topbar {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
    }

    .topbar h4 {
      font-weight: 700;
      font-size: 1.75rem;
      margin-bottom: 0.25rem;
    }

    .topbar p {
      color: var(--text-secondary);
      margin: 0;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      border: 2px solid var(--accent-color);
    }

    .search-input {
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      color: var(--text-primary);
      width: 300px;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(202, 244, 3, 0.15);
    }

    .content-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .content-card h6 {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1rem;
    }

    .table {
      color: var(--text-secondary);
      background: transparent;
    }

    .table th {
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border-color);
      padding: 1rem 0.75rem;
    }

    .table td {
      border-bottom: 1px solid rgba(39, 39, 42, 0.5);
      padding: 1rem 0.75rem;
      vertical-align: middle;
    }

    .table tbody tr:hover {
      background: rgba(202, 244, 3, 0.05);
    }

    .nav-tabs {
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
    }

    .nav-tabs .nav-link {
      border: none;
      color: var(--text-secondary);
      background: transparent;
      padding: 0.75rem 1.5rem;
      border-radius: 8px 8px 0 0;
    }

    .nav-tabs .nav-link.active {
      background: var(--accent-color);
      color: #000;
    }

    .nav-tabs .nav-link:hover {
      background: rgba(202, 244, 3, 0.1);
      color: var(--text-primary);
    }

    .badge {
      padding: 0.375rem 0.75rem;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-success {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success-color);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .badge-pending {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning-color);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .badge-failed {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger-color);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .btn {
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: #000;
    }

    .btn-primary:hover,
    .btn-primary:focus {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
      color: #000;
      transform: translateY(-1px);
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        width: 280px;
      }

      .sidebar.show {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .main-content.sidebar-collapsed {
        margin-left: 0;
      }

      .topbar {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch !important;
      }

      .topbar .d-flex {
        justify-content: center;
      }

      .user-info {
        justify-content: center;
        flex-wrap: wrap;
      }

      .search-input {
        width: 100%;
        max-width: 300px;
      }

      .content-card {
        padding: 1rem;
      }

      .table-responsive {
        font-size: 0.875rem;
      }

      .nav-tabs {
        flex-wrap: wrap;
      }

      .nav-tabs .nav-link {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }

      .d-flex.gap-2 {
        flex-direction: column;
        gap: 0.5rem !important;
      }

      .d-flex.gap-2 .form-select,
      .d-flex.gap-2 .search-input,
      .d-flex.gap-2 .btn {
        width: 100% !important;
        max-width: none !important;
      }
    }

    @media (max-width: 576px) {
      .topbar {
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .topbar h4 {
        font-size: 1.125rem;
      }

      .topbar p {
        font-size: 0.8rem;
      }

      .content {
        padding: 0.75rem;
      }

      .table th,
      .table td {
        padding: 0.375rem 0.25rem;
        font-size: 0.7rem;
      }

      .user-avatar {
        width: 28px;
        height: 28px;
      }

      .btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
      }

      .content-card {
        padding: 0.875rem;
        margin-bottom: 1rem;
      }

      .content-card h6 {
        font-size: 0.95rem;
        margin-bottom: 0.75rem;
      }

      .badge {
        font-size: 0.625rem;
        padding: 0.25rem 0.5rem;
      }

      .nav-tabs .nav-link {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
      }

      .transaction-amount {
        font-size: 0.875rem;
      }

      .sidebar-toggle {
        width: 40px;
        height: 40px;
      }

      .search-input {
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
      }
    }

    @media (max-width: 480px) {
      .topbar {
        padding: 0.75rem;
      }

      .topbar h4 {
        font-size: 1rem;
      }

      .content {
        padding: 0.5rem;
      }

      .table th,
      .table td {
        padding: 0.25rem 0.125rem;
        font-size: 0.65rem;
      }

      .user-avatar {
        width: 24px;
        height: 24px;
      }

      .sidebar-toggle {
        width: 36px;
        height: 36px;
      }

      .btn {
        padding: 0.375rem 0.5rem;
        font-size: 0.8rem;
      }

      .nav-tabs .nav-link {
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <h4>
        <img src="../../images/IconDiamond.png" alt="" width="24" height="24" class="me-2">
        PARTIVOX
      </h4>
    </div>
    
    <div class="nav-section">
      <h6>Main</h6>
      <a href="/pages/admin_dashboard/dashboard1.html">
        <i class="fas fa-chart-line"></i>
        <span>Overview</span>
      </a>
      <a href="/pages/admin_dashboard/user.html">
        <i class="fas fa-users"></i>
        <span>Users</span>
      </a>
      <a href="/pages/admin_dashboard/campaigns.html">
        <i class="fas fa-bullhorn"></i>
        <span>Campaigns</span>
      </a>
    </div>
    
    <div class="nav-section">
      <h6>Management</h6>
      <a href="/pages/admin_dashboard/transactions.html" class="active">
        <i class="fas fa-credit-card"></i>
        <span>Transactions</span>
      </a>
      <a href="/pages/admin_dashboard/reports.html">
        <i class="fas fa-chart-bar"></i>
        <span>Reports</span>
      </a>
      <a href="/pages/admin_dashboard/settings.html">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </a>
    </div>
    
    <div class="nav-section mt-auto">
      <a href="#" class="text-danger" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
      </a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="content">
      <!-- Topbar -->
      <div class="topbar d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
          <div class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
          </div>
          <div>
            <h4>Transaction Management</h4>
            <p>Monitor all financial activities: track diamond transactions, USDT conversions, withdrawal requests, payment processing, and maintain comprehensive transaction audit trails</p>
          </div>
        </div>
        <div class="user-info">
          <input type="text" class="search-input" placeholder="Search transactions..." />
          <img src="../../images/avartar1.jpg" class="user-avatar" alt="avatar" />
          <div>
            <div id="adminName" class="fw-semibold">Admin</div>
            <small class="text-muted">Administrator</small>
          </div>
        </div>
      </div>

      <!-- Transaction Content -->
      <div class="content-card">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3">
          <li class="nav-item">
            <a class="nav-link active" href="#">Pending transactions</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Transactions</a>
          </li>
        </ul>

        <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
          <input id="fltUserId" type="text" class="form-control form-control-sm bg-dark text-white" placeholder="User ID (optional)" style="width: 220px;">
          <select id="fltType" class="form-select form-select-sm bg-dark text-white" style="width: 200px;">
            <option value="">All types</option>
            <option value="buy_diamonds">Buy diamonds</option>
            <option value="convert_to_usdt">Convert to USDT</option>
            <option value="withdraw_usdt">Withdraw USDT</option>
            <option value="campaign_spend">Campaign spend</option>
            <option value="task_earning">Task earning</option>
          </select>
          <select id="fltStatus" class="form-select form-select-sm bg-dark text-white" style="width: 160px;">
            <option value="">All status</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="declined">Declined</option>
            <option value="completed">Completed</option>
          </select>
          <input id="fltFrom" type="date" class="form-control form-control-sm bg-dark text-white" style="width: 160px;">
          <input id="fltTo" type="date" class="form-control form-control-sm bg-dark text-white" style="width: 160px;">
          <button id="fltApply" class="btn btn-sm btn-secondary">Apply</button>
          <div class="ms-auto d-flex align-items-center gap-2">
            <button id="pgPrev" class="btn btn-sm btn-outline-light">Prev</button>
            <span class="text-secondary">Page <span id="pgPage">1</span></span>
            <button id="pgNext" class="btn btn-sm btn-outline-light">Next</button>
            <select id="pgLimit" class="form-select form-select-sm bg-dark text-white" style="width: 90px;">
              <option value="10" selected>10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-dark table-hover">
            <thead>
              <tr>
                <th>User</th>
                <th>Type of transaction</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="transactionTableBody">
              <!-- Transaction rows will be injected here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Transaction Modal -->
  <div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content transaction-modal">
        <div class="modal-header">
          <h5 class="modal-title" id="transactionModalLabel">Review report</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Review the details of this report</p>
          
          <h6>Report summary</h6>
          
          <table class="table table-dark table-borderless">
            <tr>
              <th>User</th>
              <td>@Lord_Knightmare</td>
            </tr>
            <tr>
              <th>Email</th>
              <td>essendivine@gmail.com</td>
            </tr>
            <tr>
              <th>Transaction type</th>
              <td>Withdrawal</td>
            </tr>
            <tr>
              <th>Amount</th>
              <td>$240</td>
            </tr>
            <tr>
              <th>Date and Time</th>
              <td>25-01-2025 / 2:30pm</td>
            </tr>
            <tr>
              <th>Transaction ID</th>
              <td>txn_023</td>
            </tr>
            <tr>
              <th>Connected wallet</th>
              <td>0×3r....908</td>
            </tr>
            <tr>
              <th>Payment method</th>
              <td>USDT</td>
            </tr>
            <tr>
              <th>Status</th>
              <td class="status-pending"> Pending</td>
            </tr>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-decline">Decline</button>
          <button type="button" class="btn btn-approve">Approve</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/admin-auth.js"></script>
  <script>
    // SIDEBAR TOGGLE FUNCTIONALITY
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.querySelector('.sidebar');
    const mainContent = document.querySelector('.main-content');
    
    if (sidebarToggle && sidebar && mainContent) {
      sidebarToggle.addEventListener('click', () => {
        // Check if we're on mobile
        const isMobile = window.innerWidth <= 768;
        
        if (isMobile) {
          // On mobile, toggle the 'show' class
          sidebar.classList.toggle('show');
        } else {
          // On desktop, toggle the 'collapsed' class
          sidebar.classList.toggle('collapsed');
          mainContent.classList.toggle('sidebar-collapsed');
        }
        
        // Change icon based on state
        const icon = sidebarToggle.querySelector('i');
        if (isMobile) {
          if (sidebar.classList.contains('show')) {
            icon.className = 'fas fa-times';
          } else {
            icon.className = 'fas fa-bars';
          }
        } else {
          if (sidebar.classList.contains('collapsed')) {
            icon.className = 'fas fa-chevron-right';
          } else {
            icon.className = 'fas fa-bars';
          }
        }
      });
      
      // Close sidebar when clicking outside on mobile
      document.addEventListener('click', (e) => {
        const isMobile = window.innerWidth <= 768;
        if (isMobile && sidebar.classList.contains('show')) {
          if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
            sidebar.classList.remove('show');
            sidebarToggle.querySelector('i').className = 'fas fa-bars';
          }
        }
      });
      
      // Handle window resize
      window.addEventListener('resize', () => {
        const isMobile = window.innerWidth <= 768;
        const icon = sidebarToggle.querySelector('i');
        
        if (!isMobile) {
          // Reset mobile classes when switching to desktop
          sidebar.classList.remove('show');
          icon.className = sidebar.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-bars';
        } else {
          // Reset desktop classes when switching to mobile
          sidebar.classList.remove('collapsed');
          mainContent.classList.remove('sidebar-collapsed');
          icon.className = sidebar.classList.contains('show') ? 'fas fa-times' : 'fas fa-bars';
        }
      });
    }

    // LOGOUT FUNCTIONALITY
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('authToken');
        window.location.href = '/pages/admin_dashboard/login.html';
      });
    }

    // Admin Transactions wiring
    if (typeof window.API_BASE_URL === 'undefined') {
      window.API_BASE_URL = window.location.origin + "/";
    }

    // Helper: Extract ObjectId string from MongoDB ObjectId object
    function getObjectIdString(objectId) {
      if (!objectId) return '';
      if (typeof objectId === 'string') return objectId;
      if (typeof objectId === 'object' && objectId.$oid) return objectId.$oid;
      if (typeof objectId === 'object' && objectId.toString) return objectId.toString();
      return String(objectId);
    }

    let state = { page: 1, limit: 20, total: 0, type: '', status: '', from: '', to: '', user_id: '' };

    function getUserNameFromToken() {
      const token = localStorage.getItem('authToken');
      if (token) {
        const payload = JSON.parse(atob(token.split('.')[1]));
        return payload.data && payload.data.name ? payload.data.name : (payload.data && payload.data.email ? payload.data.email.split('@')[0] : 'Admin');
      }
      return 'Admin';
    }

    async function fetchTransactions(params = {}) {
      try {
        console.log('fetchTransactions called with params:', params);
        const token = localStorage.getItem('authToken');
        
        if (!token) {
          console.error('No auth token found');
          throw new Error('Authentication required');
        }
        
        const urlParams = new URLSearchParams();
        
        // Build query parameters
        Object.keys(params).forEach(key => {
          if (params[key]) {
            urlParams.append(key, params[key]);
          }
        });
        
        const url = `${window.API_BASE_URL || window.location.origin + '/'}api/admin/transactions?${urlParams}`;
        console.log('Fetching transactions from:', url);
        
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        console.log('Transactions response status:', res.status);
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error('Transactions API error:', res.status, errorText);
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const data = await res.json();
        console.log('Transactions response data:', data);
        return data;
      } catch (error) {
        console.error('Error in fetchTransactions:', error);
        throw error;
      }
    }

    async function updateTransactionStatus(id, status) {
      try {
        console.log('updateTransactionStatus called with:', { id, status, idType: typeof id });
        const transactionIdString = getObjectIdString(id);
        console.log('Converted transaction ID to string:', transactionIdString);
        
        const token = localStorage.getItem('authToken');
        const res = await fetch(`${window.API_BASE_URL || window.location.origin + '/'}api/admin/transactions/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ transaction_id: transactionIdString, status })
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error('Transaction status update failed:', res.status, errorText);
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        return res.json();
      } catch (error) {
        console.error('Error in updateTransactionStatus:', error);
        throw error;
      }
    }

    function renderTransactions(transactions) {
      const tbody = document.getElementById('transactionTableBody');
      tbody.innerHTML = '';
      
      console.log('renderTransactions called with:', transactions);
      
      if (!transactions || transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No transactions found</td></tr>';
        return;
      }
      
      console.log('First transaction structure:', transactions[0]);
      
      transactions.forEach(transaction => {
        // Use ObjectId helper function
        const transactionId = getObjectIdString(transaction._id || transaction.id);
        
        console.log('Transaction ID for table:', transactionId, 'Type:', typeof transactionId, 'Original:', transaction._id);
        
        const statusClass = transaction.status === 'approved' ? 'text-success' : 
                           transaction.status === 'declined' ? 'text-danger' : 
                           transaction.status === 'pending' ? 'text-warning' : 'text-muted';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${transaction.user_name || transaction.user_email || 'Unknown User'}</td>
          <td>${transaction.type || 'Unknown'}</td>
          <td>${transaction.amount || '0'} ${transaction.currency || 'USD'}</td>
          <td>${transaction.created_at ? new Date(transaction.created_at).toLocaleDateString() : 'Unknown'}</td>
          <td><span class="${statusClass}">${transaction.status || 'pending'}</span></td>
          <td>
            ${transaction.status === 'pending' ? 
              `<button class="btn btn-sm btn-success me-1 btn-approve" data-id="${transactionId}">Approve</button>
               <button class="btn btn-sm btn-danger btn-decline" data-id="${transactionId}">Decline</button>` :
              `<span class="text-muted">No actions</span>`
            }
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      attachTransactionActionHandlers();
    }

    function showNotification(message, type = 'success') {
      const notif = document.createElement('div');
      notif.className = `alert alert-${type}`;
      notif.style.position = 'fixed';
      notif.style.top = '20px';
      notif.style.right = '20px';
      notif.style.zIndex = 9999;
      notif.innerText = message;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 2500);
    }

    function attachTransactionActionHandlers() {
      document.querySelectorAll('.btn-approve, .btn-decline').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const status = btn.classList.contains('btn-approve') ? 'approved' : 'declined';
          try {
            const data = await updateTransactionStatus(id, status);
            if (data.status === 'success') {
              showNotification(`Transaction ${status} successfully!`);
              initLoad();
            } else {
              showNotification(data.message || 'Action failed', 'danger');
            }
          } catch (e) {
            showNotification('Network error', 'danger');
          }
        });
      });
    }

    function bindFilters() {
      const $ = (id) => document.getElementById(id);
      const pageSpan = $('pgPage');
      const prev = $('pgPrev');
      const next = $('pgNext');
      const limitSel = $('pgLimit');
      const apply = $('fltApply');
      function updatePager() {
        pageSpan.textContent = String(state.page);
        // we don't know total pages without total, but if backend responds with pagination, adapt here
        prev.disabled = state.page <= 1;
      }
      prev.addEventListener('click', async () => {
        if (state.page > 1) {
          const resp = await fetchTransactions({ page: state.page - 1 });
          const items = Array.isArray(resp.data) ? resp.data : (resp.data?.items || []);
          renderTransactions(items);
          updatePager();
        }
      });
      next.addEventListener('click', async () => {
        const resp = await fetchTransactions({ page: state.page + 1 });
        const items = Array.isArray(resp.data) ? resp.data : (resp.data?.items || []);
        // naive next page handling; if no items, revert page
        if (items.length === 0) {
          state.page = Math.max(1, state.page - 1);
          showNotification('No more results', 'warning');
          return;
        }
        renderTransactions(items);
        updatePager();
      });
      limitSel.addEventListener('change', async () => {
        const newLimit = parseInt(limitSel.value || '20', 10) || 20;
        const resp = await fetchTransactions({ page: 1, limit: newLimit });
        const items = Array.isArray(resp.data) ? resp.data : (resp.data?.items || []);
        renderTransactions(items);
        updatePager();
      });
      apply.addEventListener('click', async () => {
        const type = $('fltType').value || '';
        const status = $('fltStatus').value || '';
        const from = $('fltFrom').value || '';
        const to = $('fltTo').value || '';
        const user_id = $('fltUserId').value.trim();
        const resp = await fetchTransactions({ page: 1, type, status, from, to, user_id });
        const items = Array.isArray(resp.data) ? resp.data : (resp.data?.items || []);
        renderTransactions(items);
        updatePager();
      });
    }

    async function initLoad() {
      // Set admin name
      const adminName = getUserNameFromToken();
      const nameEl = document.getElementById('adminName');
      if (nameEl) nameEl.textContent = adminName;

      // Load transactions
      try {
        bindFilters();
        const resp = await fetchTransactions({ page: 1, limit: 20 });
        const items = Array.isArray(resp.data) ? resp.data : (resp.data?.items || []);
        renderTransactions(items);
      } catch (e) {
        showNotification('Failed to load transactions', 'danger');
      }
    }

    window.addEventListener('DOMContentLoaded', initLoad);
  </script>
</body>
</html>
