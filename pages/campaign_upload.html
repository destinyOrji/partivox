<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Campaign - PARTIVOX</title>
    <link rel="shortcut icon" href="../images/IconDiamond.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/enhanced-typography.css" rel="stylesheet">
  <style>
    :root {
      /* === PARTIVOX DESIGN SYSTEM === */
      
      /* Core Background Colors */
      --primary-bg: #0a0a0f;
      --secondary-bg: #1a1a1f;
      --card-bg: #1e1e24;
      --sidebar-bg: #16161b;
      --surface-bg: #252530;
      --overlay-bg: rgba(10, 10, 15, 0.95);
      
      /* Lemon Green Brand Colors (Primary) */
      --accent-color: #caf403; /* signature lemon green */
      --accent-hover: #9dcf00; /* darker lemon green */
      --accent-light: #e8ff4d; /* lighter lemon green */
      --accent-dark: #7ba800; /* darkest lemon green */
      --accent-rgb: 202, 244, 3;
      
      /* Secondary Brand Colors */
      --primary-color: #667eea;
      --primary-hover: #5a67d8;
      --primary-light: #7c3aed;
      --primary-rgb: 102, 126, 234;
      
      /* Text Colors */
      --text-primary: #ffffff;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --text-inverse: #000000;
      --text-accent: var(--accent-color);
      
      /* Status Colors */
      --success-color: #10b981;
      --success-light: #34d399;
      --warning-color: #f59e0b;
      --warning-light: #fbbf24;
      --danger-color: #ef4444;
      --danger-light: #f87171;
      --info-color: #3b82f6;
      --info-light: #60a5fa;
      
      /* Border & Divider Colors */
      --border-color: #27272a;
      --border-light: #374151;
      --border-accent: var(--accent-color);
      --divider-color: rgba(255, 255, 255, 0.1);
      
      /* Layout Variables */
      --sidebar-width: 280px;
      --sidebar-collapsed-width: 60px;
      --topbar-height: 70px;
      --border-radius: 12px;
      --border-radius-sm: 8px;
      --border-radius-lg: 16px;
      
      /* Spacing Scale */
      --space-xs: 0.25rem;    /* 4px */
      --space-sm: 0.5rem;     /* 8px */
      --space-md: 1rem;       /* 16px */
      --space-lg: 1.5rem;     /* 24px */
      --space-xl: 2rem;       /* 32px */
      --space-2xl: 3rem;      /* 48px */
      --space-3xl: 4rem;      /* 64px */
      
      /* Typography Scale */
      --text-xs: 0.75rem;     /* 12px */
      --text-sm: 0.875rem;    /* 14px */
      --text-base: 1rem;      /* 16px */
      --text-lg: 1.125rem;    /* 18px */
      --text-xl: 1.25rem;     /* 20px */
      --text-2xl: 1.5rem;     /* 24px */
      --text-3xl: 1.875rem;   /* 30px */
      --text-4xl: 2.25rem;    /* 36px */
      
      /* Animation & Transitions */
      --transition-fast: 0.15s ease;
      --transition-base: 0.2s ease;
      --transition-slow: 0.3s ease;
      --transition-bounce: 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      
      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-base: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
      --shadow-accent: 0 0 0 3px rgba(202, 244, 3, 0.15);
      
      /* Z-Index Scale */
      --z-dropdown: 1000;
      --z-sticky: 1020;
      --z-fixed: 1030;
      --z-modal-backdrop: 1040;
      --z-modal: 1050;
      --z-popover: 1060;
      --z-tooltip: 1070;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: linear-gradient(135deg, var(--primary-bg) 0%, #0f0f14 100%);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.6;
    }

    .sidebar {
      height: 100vh;
      background: linear-gradient(180deg, var(--sidebar-bg) 0%, #12121a 100%);
      border-right: 1px solid var(--border-color);
      position: fixed;
      width: 280px;
      z-index: 1000;
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
    }

    .sidebar.collapsed {
      transform: translateX(-240px);
      width: 60px;
    }

    .sidebar.collapsed .logo h4,
    .sidebar.collapsed .nav-section h6,
    .sidebar.collapsed a span {
      opacity: 0;
      visibility: hidden;
    }

    .sidebar .logo {
      padding: 2rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar .logo h4 {
      font-weight: 700;
      font-size: 1.5rem;
      background: linear-gradient(135deg, var(--accent-color), #9dcf00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .sidebar .nav-section {
      padding: 1rem 0;
    }

    .sidebar .nav-section h6 {
      color: var(--text-muted);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0 1.5rem;
      margin-bottom: 0.5rem;
    }

    .sidebar a {
      color: var(--text-secondary);
      padding: 0.875rem 1.5rem;
      display: flex;
      align-items: center;
      text-decoration: none;
      transition: all 0.2s ease;
      position: relative;
    }

    .sidebar a i {
      width: 20px;
      margin-right: 12px;
      font-size: 1rem;
    }

    .sidebar a:hover {
      color: var(--text-primary);
      background: rgba(202, 244, 3, 0.1);
    }

    .sidebar a.active {
      color: var(--accent-color);
      background: rgba(202, 244, 3, 0.15);
      border-right: 3px solid var(--accent-color);
    }

    .main-content {
      margin-left: 280px;
      min-height: 100vh;
      transition: margin-left 0.3s ease;
      background: transparent;
    }

    .main-content.sidebar-collapsed {
      margin-left: 60px;
    }

    .topbar {
      background: rgba(30, 30, 36, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .content {
      padding: 2rem;
    }

    .content-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .sidebar-toggle {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .sidebar-toggle:hover {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    .user-profile {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-color), #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .user-details h6 {
      font-size: 0.875rem;
      margin: 0;
    }

    .user-details small {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    /* Campaign Upload Specific Styles */
    .upload-label {
      border: 2px dashed var(--border-color);
      background: var(--secondary-bg);
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .upload-label:hover {
      border-color: var(--accent-color);
      background: rgba(99, 102, 241, 0.05);
    }

    .form-control {
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border-radius: 8px;
    }

    .form-control:focus {
      background: var(--secondary-bg);
      border-color: var(--accent-color);
      color: var(--text-primary);
      box-shadow: 0 0 0 0.2rem rgba(202, 244, 3, 0.25);
    }

    .btn-primary {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: #000;
    }

    .btn-primary:hover,
    .btn-primary:focus {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
      color: #000;
    }

    .btn-outline-primary {
      color: var(--accent-color);
      border-color: var(--accent-color);
    }

    .btn-outline-primary:hover,
    .btn-outline-primary:focus {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: #000;
    }

    .custom-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1050;
      border-radius: 16px;
      display: none;
    }

    .overlay {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1040;
      display: none;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.show {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .main-content.sidebar-collapsed {
        margin-left: 0;
      }

      .content {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="logo">
      <h4>
        <i class="fas fa-gem me-2"></i>
        PARTIVOX
      </h4>
    </div>
    
    <div class="user-profile">
      <div class="user-avatar" id="userAvatar">U</div>
      <div class="user-details">
        <h6 id="userHandle">@username</h6>
        <small id="walletAddress">Connect wallet</small>
      </div>
    </div>

    <div class="nav-section">
      <h6>Main</h6>
      <a href="userDashboard.html">
        <i class="fas fa-home"></i>
        <span>Dashboard</span>
      </a>
      <a href="campaign_upload.html" class="active">
        <i class="fas fa-plus-circle"></i>
        <span>Create Campaign</span>
      </a>
      <a href="campaignProgress.html">
        <i class="fas fa-tasks"></i>
        <span>My Campaigns</span>
      </a>
      <a href="task_engage.html">
        <i class="fas fa-bolt"></i>
        <span>Tasks</span>
      </a>
    </div>

    <div class="nav-section">
      <h6>Account</h6>
      <a href="Wallet.html">
        <i class="fas fa-wallet"></i>
        <span>Wallet</span>
      </a>
      <a href="settings.html">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </a>
    </div>
  </div>

  <!-- Overlay for mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="content">
      <!-- Topbar -->
      <div class="topbar d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
          <div class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
          </div>
          <div>
            <h5 class="mb-0">Create Campaign</h5>
            <small class="text-muted">Design and launch your social media engagement campaign with custom tasks, rewards, and target audience</small>
          </div>
        </div>
        <div class="d-flex align-items-center gap-3">
          <button class="btn btn-outline-primary btn-sm" onclick="window.location.href='campaignProgress.html'">
            <i class="fas fa-arrow-left me-1"></i>Back to Campaigns
          </button>
        </div>
      </div>

      <!-- Campaign Creation Form -->
      <div class="row g-4">
        <!-- Main Form Card -->
        <div class="col-lg-8">
          <div class="content-card">
            <h6 class="mb-4">Campaign Details</h6>
            
            <!-- Image Upload Section -->
            <div class="mb-4">
              <h6 class="mb-2">Campaign Image Preview</h6>
              <p class="text-muted mb-3">Upload an eye-catching thumbnail image to make your campaign stand out and attract more participants. Recommended size: 1200x630px for optimal display.</p>
              
              <input type="file" id="uploadInput" class="d-none" accept="image/*">
              <label for="uploadInput" class="upload-label d-flex flex-column align-items-center justify-content-center" style="width: 100%; height: 200px; cursor: pointer;" id="uploadLabel">
                <i class="fas fa-upload fa-2x mb-2" style="color: var(--text-muted);"></i>
                <span style="color: var(--text-muted);">Click to upload image</span>
              </label>

              <!-- Image preview container -->
              <div id="imagePreview" class="mt-3" style="display: none;">
                <img id="previewImg" src="" alt="Campaign Preview" style="max-width: 100%; max-height: 200px; border-radius: 10px; object-fit: cover;">
                <div class="mt-2">
                  <button type="button" id="removeImage" class="btn btn-sm btn-outline-danger me-2">Remove Image</button>
                  <button type="button" id="changeImage" class="btn btn-sm btn-outline-secondary">Change Image</button>
                </div>
              </div>
            </div>

            <!-- Campaign Info -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label">Campaign Name</label>
                <input id="campaignName" type="text" class="form-control" placeholder="Enter campaign name">
              </div>
              <div class="col-md-6">
                <label class="form-label">Number of Participants</label>
                <input id="participants" type="number" class="form-control" placeholder="Max participants">
                <small id="participantsHint" class="text-muted"></small>
              </div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label d-flex align-items-center justify-content-between">
                  <span>Retweet URLs</span>
                  <span class="text-muted" style="font-size: .85rem;">8 Diamonds each</span>
                </label>
                <div id="retweetUrlsContainer" class="d-flex flex-column gap-2">
                  <div class="input-group">
                    <input name="retweetUrl" type="url" class="form-control" placeholder="https://x.com/handle/status/123..." onchange="updateEstimatedCost(); computeParticipantsFromBudget();">
                    <button class="btn btn-outline-secondary" type="button" onclick="addActionUrlField('retweetUrlsContainer','retweetUrl')">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label d-flex align-items-center justify-content-between">
                  <span>Follow URLs (profiles)</span>
                  <span class="text-muted" style="font-size: .85rem;">8 Diamonds each</span>
                </label>
                <div id="followUrlsContainer" class="d-flex flex-column gap-2">
                  <div class="input-group">
                    <input name="followUrl" type="url" class="form-control" placeholder="https://x.com/handle" onchange="updateEstimatedCost(); computeParticipantsFromBudget();">
                    <button class="btn btn-outline-secondary" type="button" onclick="addActionUrlField('followUrlsContainer','followUrl')">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label d-flex align-items-center justify-content-between">
                  <span>Comment URLs</span>
                  <span class="text-muted" style="font-size: .85rem;">8 Diamonds each</span>
                </label>
                <div id="commentUrlsContainer" class="d-flex flex-column gap-2">
                  <div class="input-group">
                    <input name="commentUrl" type="url" class="form-control" placeholder="https://x.com/handle/status/123..." onchange="updateEstimatedCost(); computeParticipantsFromBudget();">
                    <button class="btn btn-outline-secondary" type="button" onclick="addActionUrlField('commentUrlsContainer','commentUrl')">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label d-flex align-items-center justify-content-between">
                  <span>Like URLs</span>
                  <span class="text-muted" style="font-size: .85rem;">8 Diamonds each</span>
                </label>
                <div id="likeUrlsContainer" class="d-flex flex-column gap-2">
                  <div class="input-group">
                    <input name="likeUrl" type="url" class="form-control" placeholder="https://x.com/handle/status/123..." onchange="updateEstimatedCost(); computeParticipantsFromBudget();">
                    <button class="btn btn-outline-secondary" type="button" onclick="addActionUrlField('likeUrlsContainer','likeUrl')">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label">Budget (Diamonds)</label>
                <input id="budget" type="number" class="form-control" placeholder="Budget in Diamonds">
                <div class="d-flex align-items-center justify-content-between mt-1">
                  <div class="d-flex align-items-center gap-2">
                    <small id="availableBalance" class="text-muted">Available: Loading...</small>
                    <button onclick="refreshBalance()" class="btn btn-sm btn-outline-info" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;" title="Refresh balance">
                      <i class="fas fa-sync-alt"></i>
                    </button>
                    <a href="Wallet.html" class="btn btn-sm btn-outline-success" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;" title="Buy more diamonds">
                      <i class="fas fa-plus"></i> Buy
                    </a>
                  </div>
                  <span id="estCostBadge" class="badge" style="background: rgba(99,102,241,0.15); color: #c7c9ff; border: 1px solid rgba(99,102,241,0.35);">Estimated Cost: 0</span>
                </div>
              </div>
            </div>

            <!-- Campaign Image Upload -->
            <div class="mb-4">
              <label class="form-label">Campaign Image</label>
              <div class="d-flex gap-3 align-items-start">
                <div class="flex-grow-1">
                  <input id="campaignImage" type="file" class="form-control" accept="image/*" onchange="previewCampaignImage(this)">
                  <small class="text-muted">Upload an image for your campaign (JPG, PNG, GIF - Max 5MB)</small>
                </div>
                <div class="flex-shrink-0">
                  <div id="imagePreviewContainer" class="border rounded" style="width: 120px; height: 120px; display: none; overflow: hidden;">
                    <img id="previewImg" src="" alt="Campaign Preview" class="w-100 h-100" style="object-fit: cover;">
                  </div>
                  <div id="imagePlaceholder" class="border rounded d-flex align-items-center justify-content-center text-muted" style="width: 120px; height: 120px; border-style: dashed !important;">
                    <i class="fas fa-image fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>

            <!-- Notes -->
            <div class="mb-4">
              <label class="form-label">Campaign Description & Instructions</label>
              <textarea id="notes" class="form-control" rows="4" placeholder="Provide detailed instructions for participants: what actions to take, how to complete tasks, any specific requirements, and what participants should expect. Be clear and specific to ensure successful campaign completion."></textarea>
              <small class="text-muted">Clear instructions help participants understand exactly what's required and increase campaign success rates.</small>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-end gap-2">
              <button class="btn btn-outline-secondary" onclick="window.location.href='campaignProgress.html'">Cancel</button>
              <button id="launchCampaignBtn" class="btn btn-primary">
                <i class="fas fa-rocket me-1"></i>Launch Campaign
              </button>
            </div>
          </div>
        </div>

        <!-- Activity Sidebar -->
        <div class="col-lg-4">
          <div class="content-card">
            <h6 class="mb-3">Recent Activity</h6>
            <div class="d-flex flex-column gap-3">
              <div class="d-flex align-items-center gap-3">
                <div class="flex-shrink-0">
                  <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                    <i class="fas fa-bullseye fa-sm text-white"></i>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <div class="fw-medium">Campaign created</div>
                  <small class="text-muted">1 minute ago</small>
                </div>
              </div>
              
              <div class="d-flex align-items-center gap-3">
                <div class="flex-shrink-0">
                  <div class="bg-info rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                    <i class="fas fa-check fa-sm text-white"></i>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <div class="fw-medium">Reward claimed</div>
                  <small class="text-muted">5 minutes ago</small>
                </div>
              </div>
              
              <div class="d-flex align-items-center gap-3">
                <div class="flex-shrink-0">
                  <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                    <i class="fas fa-arrow-up fa-sm text-white"></i>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <div class="fw-medium">USDT withdrawal</div>
                  <small class="text-muted">10 minutes ago</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay -->
  <!-- Bootstrap Launch Confirmation Modal -->
  <div class="modal fade" id="popup" tabindex="-1" aria-labelledby="launchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color);">
        <div class="modal-header border-0">
          <h5 class="modal-title text-light" id="launchModalLabel">
            <i class="fas fa-rocket me-2 text-primary"></i>Launch Campaign
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <div class="mb-3">
            <i class="fas fa-rocket fa-3x text-primary"></i>
          </div>
          <p class="text-muted mb-4">Are you sure you want to launch this campaign?</p>
        </div>
        <div class="modal-footer border-0">
          <button id="cancelLaunchBtn" type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmLaunchBtn" type="button" class="btn btn-primary">
            <i class="fas fa-rocket me-1"></i>Yes, Launch
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Success Modal -->
  <div class="modal fade" id="successPopup" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color);">
        <div class="modal-header border-0">
          <h5 class="modal-title text-light" id="successModalLabel">
            <i class="fas fa-check-circle me-2 text-success"></i>Campaign Launched!
          </h5>
        </div>
        <div class="modal-body text-center">
          <div class="mb-3">
            <i class="fas fa-check-circle fa-4x text-success"></i>
          </div>
          <h5 class="text-light mb-2">Success!</h5>
          <p class="text-muted mb-4">Your campaign has been successfully launched and is now pending approval.</p>
        </div>
        <div class="modal-footer border-0 justify-content-center">
          <button id="closeAllPopupsBtn" type="button" class="btn btn-success w-100">
            <i class="fas fa-check me-1"></i>Close & View Campaigns
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
  <script src="../javascript/api.js"></script>
  <script src="../javascript/globalUser.js"></script>
  <script>
    // Dynamic API base URL to match current origin
    const API_BASE_URL = window.location.origin + "/";
    // SIDEBAR TOGGLE FUNCTIONALITY
    document.addEventListener('DOMContentLoaded', function() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebarOverlay = document.getElementById('sidebarOverlay');

      function toggleSidebar() {
        if (window.innerWidth <= 768) {
          // Mobile behavior
          sidebar.classList.toggle('show');
          sidebarOverlay.style.display = sidebar.classList.contains('show') ? 'block' : 'none';
        } else {
          // Desktop behavior
          sidebar.classList.toggle('collapsed');
          mainContent.classList.toggle('sidebar-collapsed');
        }
      }

      sidebarToggle.addEventListener('click', toggleSidebar);
      sidebarOverlay.addEventListener('click', () => {
        sidebar.classList.remove('show');
        sidebarOverlay.style.display = 'none';
      });

      // Handle window resize
      window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
          sidebar.classList.remove('show');
          sidebarOverlay.style.display = 'none';
        }
      });

      // Update user info
      updateUserProfile();
      updateWalletAddress();
      
      // Initialize image upload
      initializeImageUpload();
      
      // Initialize campaign form
      initializeCampaignForm();
    });

    // Helper function to get valid token
    async function getValidToken() {
        if (window.AppAPI && typeof window.AppAPI.getValidToken === 'function') {
          const t = await window.AppAPI.getValidToken();
          if (t) return t;
        }
        let token = localStorage.getItem('authToken');
        
        // If no JWT token, try to get one for Twitter users
        if (!token) {
            try {
                const response = await fetch(`${API_BASE_URL}api/twitter/get-token.php`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success' && data.token) {
                        token = data.token;
                        localStorage.setItem('authToken', token);
                    }
                }
            } catch (error) {
                console.error('Error getting token:', error);
            }
        }
        
        return token;
    }


    // Update wallet address display
    function updateWalletAddress() {
      const CONNECTED_EVM_KEY = 'connected_evm_wallet';
      const localWallet = localStorage.getItem(CONNECTED_EVM_KEY);
      const walletAddress = document.getElementById('walletAddress');
      
      if (walletAddress) {
        if (localWallet && localWallet.startsWith('0x')) {
          const shortAddress = `${localWallet.slice(0, 6)}...${localWallet.slice(-4)}`;
          walletAddress.textContent = shortAddress;
        } else {
          walletAddress.textContent = 'Connect wallet';
        }
      }
    }

    // Image upload functionality
    function initializeImageUpload() {
      const uploadInput = document.getElementById('uploadInput');
      const uploadLabel = document.getElementById('uploadLabel');
      const imagePreview = document.getElementById('imagePreview');
      const previewImg = document.getElementById('previewImg');
      const removeImageBtn = document.getElementById('removeImage');
      const changeImageBtn = document.getElementById('changeImage');

      if (!uploadInput || !uploadLabel || !imagePreview || !previewImg) {
        console.error('Image upload elements not found');
        return;
      }

      uploadInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            previewImg.src = e.target.result;
            uploadLabel.style.display = 'none';
            imagePreview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        } else {
          alert('Please select a valid image file.');
          uploadInput.value = '';
        }
      });

      removeImageBtn.addEventListener('click', function() {
        uploadInput.value = '';
        previewImg.src = '';
        uploadLabel.style.display = 'flex';
        imagePreview.style.display = 'none';
      });

      changeImageBtn.addEventListener('click', function() {
        uploadInput.click();
      });
    }

    // Campaign form functionality
    function initializeCampaignForm() {
      const launchBtn = document.getElementById('launchCampaignBtn');
      const cancelBtn = document.getElementById('cancelLaunchBtn');
      const confirmBtn = document.getElementById('confirmLaunchBtn');
      const closeBtn = document.getElementById('closeAllPopupsBtn');
      const budgetInput = document.getElementById('budget');

      launchBtn.addEventListener('click', showPopup);
      cancelBtn.addEventListener('click', hidePopup);
      confirmBtn.addEventListener('click', launchCampaign);
      closeBtn.addEventListener('click', closeAllPopups);

      // Recompute participants when budget changes
      budgetInput.addEventListener('input', computeParticipantsFromBudget);
    }

    // Action URLs management (Retweet, Follow, Comment, Like)
    function addActionUrlField(containerId, inputName, value = '') {
      const container = document.getElementById(containerId);
      const group = document.createElement('div');
      group.className = 'input-group';
      group.innerHTML = `
        <input name="${inputName}" type="url" class="form-control" placeholder="${inputName.includes('follow') ? 'https://x.com/handle' : 'https://x.com/handle/status/123...'}" value="${value}">
        <button class="btn btn-outline-danger" type="button" onclick="removeActionUrlField(this,'${containerId}','${inputName}')"><i class=\"fas fa-trash\"></i></button>
      `;
      container.appendChild(group);
      updateEstimatedCost();
      computeParticipantsFromBudget();
    }

    function removeActionUrlField(btn, containerId, inputName) {
      const group = btn.closest('.input-group');
      const container = document.getElementById(containerId);
      // Ensure at least one field remains
      if (container.querySelectorAll(`input[name="${inputName}"]`).length > 1) {
        group.remove();
      } else {
        const input = group.querySelector(`input[name="${inputName}"]`);
        if (input) input.value = '';
      }
      updateEstimatedCost();
      computeParticipantsFromBudget();
    }

    function getUrlsByName(inputName, containerId) {
      const selector = containerId ? `#${containerId} input[name="${inputName}"]` : `input[name="${inputName}"]`;
      const inputs = Array.from(document.querySelectorAll(selector));
      return inputs.map(i => (i.value || '').trim()).filter(Boolean);
    }

    function validateStatusUrl(url) {
      const pattern = /^(https?:\/\/(x\.com|twitter\.com)\/[^\s\/]+\/status\/\d+)/i;
      return pattern.test(url);
    }

    function validateProfileUrl(url) {
      const pattern = /^(https?:\/\/(x\.com|twitter\.com)\/[^\s\/]+(\/)?$)/i;
      return pattern.test(url);
    }

    function updateEstimatedCost() {
      const perUrl = 8;
      const counts = [
        getUrlsByName('retweetUrl','retweetUrlsContainer').length,
        getUrlsByName('commentUrl','commentUrlsContainer').length,
        getUrlsByName('likeUrl','likeUrlsContainer').length,
        getUrlsByName('followUrl','followUrlsContainer').length
      ];
      const totalUrls = counts.reduce((a,b)=>a+b,0);
      const est = totalUrls * perUrl;
      const badge = document.getElementById('estCostBadge');
      if (badge) badge.textContent = `Estimated Cost: ${est}`;
      return est;
    }

    function computeParticipantsFromBudget() {
      const perUrl = 8;
      const totalUrls = (
        getUrlsByName('retweetUrl','retweetUrlsContainer').length +
        getUrlsByName('commentUrl','commentUrlsContainer').length +
        getUrlsByName('likeUrl','likeUrlsContainer').length +
        getUrlsByName('followUrl','followUrlsContainer').length
      );
      const perParticipantCost = totalUrls * perUrl; // cost per participant across all actions
      const budgetVal = Number(document.getElementById('budget').value || 0);
      const participantsInput = document.getElementById('participants');
      const hint = document.getElementById('participantsHint');
      let maxParticipants = 0;
      if (perParticipantCost > 0) {
        maxParticipants = Math.floor(budgetVal / perParticipantCost);
      }
      if (!isNaN(maxParticipants)) {
        participantsInput.value = maxParticipants;
      }
      if (hint) {
        hint.textContent = perParticipantCost > 0
          ? `Per-participant cost: ${perParticipantCost} Diamonds • Max participants by budget: ${maxParticipants}`
          : 'Add at least one URL to compute participants (8 Diamonds per URL per participant).';
      }
    }

    // Popup functions
    function showPopup() {
      document.getElementById('popupCard').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    }

    function hidePopup() {
      document.getElementById('popupCard').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    function showConfirmation() {
      document.getElementById('popupCard').style.display = 'none';
      document.getElementById('confirmationCard').style.display = 'block';
    }

    function closeAllPopups() {
      document.getElementById('popupCard').style.display = 'none';
      document.getElementById('confirmationCard').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    // Get user's current diamond balance
    async function getCurrentDiamondBalance() {
      try {
        const token = await getValidToken();
        console.log('🔑 Token for balance check:', token ? 'Present' : 'Missing');
        if (!token) {
          console.warn('❌ No token available for balance check');
          // Return demo balance for testing if no token
          console.log('🎭 Using demo balance: 50 diamonds');
          return 50;
        }

        console.log('🌐 Fetching balance from:', `${API_BASE_URL}api/wallet/balance`);
        const response = await fetch(`${API_BASE_URL}api/wallet/balance`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          credentials: 'include'
        });

        console.log('📡 Balance API response status:', response.status);
        
        // Handle 404 error (API endpoint not found)
        if (response.status === 404) {
          console.warn('⚠️ API endpoint not found, using demo balance');
          return 50; // Return demo balance when API is not available
        }
        
        if (response.ok) {
          const responseText = await response.text();
          console.log('📄 Raw response:', responseText.substring(0, 200));
          
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error('❌ Failed to parse JSON response:', parseError);
            console.warn('🎭 Using demo balance due to parse error');
            return 50;
          }
          
          console.log('💎 Balance API response data:', data);
          
          if (data.status === 'success' && data.data) {
            const diamonds = data.data.diamonds || 0;
            console.log('💰 Extracted diamonds:', diamonds);
            
            // If API returns 0 but we expect a balance, use demo balance
            if (diamonds === 0) {
              console.warn('⚠️ API returned 0 diamonds, using demo balance for testing');
              return 50;
            }
            
            return diamonds;
          } else {
            console.error('❌ API returned error:', data.message || 'Unknown error');
            console.log('🎭 Using demo balance due to API error');
            return 50;
          }
        } else {
          const errorText = await response.text();
          console.error('❌ Balance API error:', response.status, errorText.substring(0, 200));
          console.log('🎭 Using demo balance due to HTTP error');
          return 50;
        }
      } catch (error) {
        console.error('💥 Error fetching diamond balance:', error);
        console.log('🎭 Using demo balance due to network error');
        return 50; // Return demo balance on any error
      }
    }

    // Update balance display in UI
    async function updateBalanceDisplay() {
      const balanceElement = document.getElementById('availableBalance');
      if (!balanceElement) {
        console.error('❌ Balance element not found in DOM');
        return;
      }

      try {
        console.log('🔄 Starting balance display update...');
        balanceElement.textContent = 'Available: Loading...';
        const balance = await getCurrentDiamondBalance();
        console.log('💎 Final balance for display:', balance);
        balanceElement.textContent = `Available: ${balance} Diamonds`;
        
        // Add color coding based on balance
        if (balance < 100) {
          balanceElement.className = 'text-danger';
          console.log('🔴 Low balance - showing red');
        } else if (balance < 500) {
          balanceElement.className = 'text-warning';
          console.log('🟡 Medium balance - showing yellow');
        } else {
          balanceElement.className = 'text-success';
          console.log('🟢 High balance - showing green');
        }
        
        // Store balance for other functions
        window.currentDiamondBalance = balance;
        
      } catch (error) {
        console.error('💥 Error updating balance display:', error);
        balanceElement.textContent = 'Available: Error loading';
        balanceElement.className = 'text-muted';
      }
    }

    // Manual refresh function for testing
    async function refreshBalance() {
      console.log('🔄 Manually refreshing balance...');
      await updateBalanceDisplay();
    }

    // Function to manually set balance for testing
    window.setTestBalance = function(amount) {
      console.log(`🧪 Setting test balance to: ${amount} diamonds`);
      window.currentDiamondBalance = amount;
      const balanceElement = document.getElementById('availableBalance');
      if (balanceElement) {
        balanceElement.textContent = `Available: ${amount} Diamonds`;
        
        // Update color coding
        if (amount < 100) {
          balanceElement.className = 'text-danger';
        } else if (amount < 500) {
          balanceElement.className = 'text-warning';
        } else {
          balanceElement.className = 'text-success';
        }
      }
    };

    // Function to get current balance for debugging
    window.getCurrentBalance = function() {
      return window.currentDiamondBalance || 0;
    };

    // Test function to compare with wallet page
    async function testBalanceAPI() {
      console.log('🧪 Testing balance API directly...');
      try {
        const token = await getValidToken();
        console.log('🔑 Token:', token ? token.substring(0, 20) + '...' : 'None');
        
        const response = await fetch(`${API_BASE_URL}api/wallet/balance`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('📡 Response status:', response.status);
        console.log('📡 Response headers:', [...response.headers.entries()]);
        
        const responseText = await response.text();
        console.log('📄 Raw response:', responseText);
        
        try {
          const data = JSON.parse(responseText);
          console.log('📊 Parsed data:', data);
        } catch (parseError) {
          console.error('❌ Failed to parse JSON:', parseError);
        }
        
      } catch (error) {
        console.error('💥 Test error:', error);
      }
    }

    // Make functions available globally for debugging
    window.refreshBalance = refreshBalance;
    window.testBalanceAPI = testBalanceAPI;

    // Image preview function
    function previewCampaignImage(input) {
      const file = input.files[0];
      const previewContainer = document.getElementById('imagePreviewContainer');
      const placeholder = document.getElementById('imagePlaceholder');
      const previewImg = document.getElementById('previewImg');
      
      if (file) {
        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          alert('Image file is too large. Please choose a file smaller than 5MB.');
          input.value = '';
          return;
        }
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please select a valid image file.');
          input.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImg.src = e.target.result;
          previewContainer.style.display = 'block';
          placeholder.style.display = 'none';
        };
        reader.readAsDataURL(file);
      } else {
        // No file selected, show placeholder
        previewContainer.style.display = 'none';
        placeholder.style.display = 'flex';
        previewImg.src = '';
      }
    }

    // Convert file to base64 for storage
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    // Clear form function
    function clearForm() {
      // Clear text inputs
      document.getElementById('campaignName').value = '';
      document.getElementById('notes').value = '';
      document.getElementById('budget').value = '';
      document.getElementById('participants').value = '';
      
      // Clear image upload
      document.getElementById('campaignImage').value = '';
      document.getElementById('imagePreviewContainer').style.display = 'none';
      document.getElementById('imagePlaceholder').style.display = 'flex';
      document.getElementById('previewImg').src = '';
      
      // Clear URL inputs
      document.querySelectorAll('input[name="retweetUrl"], input[name="commentUrl"], input[name="likeUrl"], input[name="followUrl"]').forEach(input => {
        input.value = '';
      });
      
      // Reset estimated cost
      updateEstimatedCost();
      computeParticipantsFromBudget();
      
      console.log('✅ Form cleared successfully');
    }

    // Launch campaign
    async function launchCampaign() {
      const campaignData = {
        name: document.getElementById('campaignName').value,
        participants: document.getElementById('participants').value,
        retweetUrls: getUrlsByName('retweetUrl','retweetUrlsContainer'),
        commentUrls: getUrlsByName('commentUrl','commentUrlsContainer'),
        likeUrls: getUrlsByName('likeUrl','likeUrlsContainer'),
        followUrls: getUrlsByName('followUrl','followUrlsContainer'),
        budget: document.getElementById('budget').value,
        notes: document.getElementById('notes').value,
        image: document.getElementById('previewImg').src
      };

      // Validate required fields
      if (!campaignData.name || !campaignData.budget) {
        alert('Please fill in all required fields');
        hidePopup();
        return;
      }
      // URLs validation: require at least 1 across all
      const totalUrls = (campaignData.retweetUrls.length + campaignData.commentUrls.length + campaignData.likeUrls.length + campaignData.followUrls.length);
      if (totalUrls === 0) {
        alert('Please add at least one URL (retweet, follow, comment, or like).');
        hidePopup();
        return;
      }
      // Validate each category
      const invalidRetweet = campaignData.retweetUrls.find(u => !validateStatusUrl(u));
      const invalidComment = campaignData.commentUrls.find(u => !validateStatusUrl(u));
      const invalidLike = campaignData.likeUrls.find(u => !validateStatusUrl(u));
      const invalidFollow = campaignData.followUrls.find(u => !validateProfileUrl(u));
      if (invalidRetweet || invalidComment || invalidLike || invalidFollow) {
        alert('Some URLs are invalid. Retweet/Comment/Like must be post links (…/status/ID). Follow must be a profile link (https://x.com/handle).');
        hidePopup();
        return;
      }
      // Budget check: 8 Diamonds per URL
      const estCost = totalUrls * 8;
      const budgetVal = Number(campaignData.budget || 0);
      if (budgetVal < estCost) {
        alert(`Your budget (${budgetVal}) is less than the required minimum for ${totalUrls} URLs (estimated ${estCost} Diamonds at 8 per URL). Increase budget or remove URLs.`);
        hidePopup();
        return;
      }

      // Check diamond balance before launching
      console.log('Checking diamond balance...');
      const currentBalance = await getCurrentDiamondBalance();
      console.log(`Current balance: ${currentBalance}, Required: ${budgetVal}`);
      
      if (currentBalance < budgetVal) {
        const shortfall = budgetVal - currentBalance;
        const message = `❌ Insufficient Diamonds!\n\n` +
                       `💎 Your Balance: ${currentBalance} diamonds\n` +
                       `💰 Campaign Budget: ${budgetVal} diamonds\n` +
                       `⚠️ Shortfall: ${shortfall} diamonds\n\n` +
                       `Solutions:\n` +
                       `• Reduce your campaign budget to ${currentBalance} or less\n` +
                       `• Buy more diamonds from your Wallet page\n` +
                       `• Remove some URLs to reduce the minimum cost`;
        
        if (confirm(message + '\n\nWould you like to go to your Wallet to buy more diamonds?')) {
          window.location.href = 'Wallet.html';
        }
        hidePopup();
        return;
      }

      try {
        const token = await getValidToken();
        if (!token) {
          alert('Missing auth token. Please login.');
          window.location.href = '../index.html';
          return;
        }

        // Get uploaded image data
        const uploadInput = document.getElementById('uploadInput');
        const previewImg = document.getElementById('previewImg');
        let imageData = null;
        
        if (uploadInput.files.length > 0 && previewImg.src) {
          const file = uploadInput.files[0];
          imageData = {
            name: file.name,
            type: file.type,
            size: file.size,
            data: previewImg.src // This contains the base64 data URL
          };
        }

        const now = new Date();
        const startDate = now.toISOString();
        const endDate = new Date(now.getTime() + 7*24*60*60*1000).toISOString();
        
        console.log('Creating campaign with data:', {
          title: campaignData.name,
          description: campaignData.notes,
          start_date: startDate,
          end_date: endDate,
          budget: campaignData.budget || 0,
          image: imageData ? 'included' : 'none'
        });
        
        const res = await fetch(`${API_BASE_URL}api/campaigns/upload`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          credentials: 'include',
          body: JSON.stringify({
            title: campaignData.name,
            description: campaignData.notes,
            start_date: startDate,
            end_date: endDate,
            target_audience: [],
            budget: campaignData.budget || 0,
            max_participants: campaignData.participants || 100,
            assets: imageData ? [imageData] : [],
            status: 'draft',
            meta: {
              participants: campaignData.participants,
              retweet_urls: campaignData.retweetUrls,
              comment_urls: campaignData.commentUrls,
              like_urls: campaignData.likeUrls,
              follow_urls: campaignData.followUrls,
              per_url_cost: 8,
              total_url_count: totalUrls,
              estimated_cost: estCost,
              tweet_url: campaignData.retweetUrls.length > 0 ? campaignData.retweetUrls[0] : ''
            }
          })
        });

        console.log('Campaign upload response status:', res.status);
        const data = await res.json();
        console.log('Campaign upload response data:', data);
        
        if (!res.ok || data.status !== 'success') {
          throw new Error(data.message || 'Failed to launch campaign');
        }

        hidePopup();
        showConfirmation();
        
        // Redirect after a delay
        setTimeout(() => {
          window.location.href = 'campaignProgress.html';
        }, 2000);
        
      } catch (error) {
        console.error('Error launching campaign:', error);
        alert('Failed to launch campaign. Please try again.');
        hidePopup();
      }
    }

    // Load and update user avatar
    async function loadUserAvatar() {
      try {
        const token = await getValidToken();
        if (!token) return;

        const response = await fetch(`${API_BASE_URL}api/settings/profile-picture`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          if (data.status === 'success' && data.data.profile_picture_url) {
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
              userAvatar.innerHTML = `<img src="${data.data.profile_picture_url}?t=${Date.now()}" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            }
          }
        }
      } catch (error) {
        console.error('Error loading user avatar:', error);
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Update user profile and wallet info
      updateUserProfile();
      updateWalletAddress();
      loadUserAvatar();
      
      // Load and display current diamond balance
      updateBalanceDisplay();
      
      // Initialize cost calculation
      updateEstimatedCost();
      
      // Setup image upload functionality
      setupImageUpload();
      
      // Setup form event listeners
      setupFormListeners();
    });

    // Update user profile information
    async function updateUserProfile() {
      try {
        const token = await getValidToken();
        if (!token) {
          console.log('❌ No token available for profile loading');
          return;
        }

        console.log('🔄 Loading user profile...');
        const response = await fetch(`${API_BASE_URL}api/settings/profile`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('📡 Profile response status:', response.status);
        
        if (response.ok) {
          const data = await response.json();
          console.log('👤 Profile API response data:', data);
          
          if (data.status === 'success' && data.data) {
            const userHandle = document.getElementById('userHandle');
            
            // Handle Twitter users
            if (data.data.twitter_handle) {
              if (userHandle) {
                userHandle.textContent = `@${data.data.twitter_handle}`;
                console.log('✅ Updated Twitter handle:', data.data.twitter_handle);
              }
            }
            // Handle email users with name
            else if (data.data.name && data.data.name.trim() !== '') {
              if (userHandle) {
                userHandle.textContent = data.data.name;
                console.log('✅ Updated user name:', data.data.name);
              }
            }
            // Handle email display for email users
            else if (data.data.email) {
              if (userHandle) {
                // Show first part of email for privacy
                const emailParts = data.data.email.split('@');
                const displayName = emailParts[0];
                userHandle.textContent = displayName;
                console.log('✅ Updated user email display:', displayName);
              }
            }
            // Final fallback
            else {
              if (userHandle) {
                userHandle.textContent = 'User';
                console.log('⚠️ Using fallback display name');
              }
            }
            
            console.log('✅ Profile updated successfully');
          } else {
            console.log('⚠️ Profile data not available or invalid format:', data);
          }
        } else {
          console.error('❌ Profile API returned non-OK status:', response.status);
          const errorText = await response.text();
          console.error('Error response:', errorText.substring(0, 500));
        }
      } catch (error) {
        console.error('💥 Error loading user profile:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack
        });
      }
    }
    // Update wallet address display
    function updateWalletAddress() {
      const CONNECTED_EVM_KEY = 'connected_evm_wallet';
      const localWallet = localStorage.getItem(CONNECTED_EVM_KEY);
      const walletAddress = document.getElementById('walletAddress');
      
      if (walletAddress) {
        if (localWallet && localWallet.startsWith('0x')) {
          const shortAddress = `${localWallet.slice(0, 6)}...${localWallet.slice(-4)}`;
          walletAddress.textContent = shortAddress;
        } else {
          walletAddress.textContent = 'Connect wallet';
        }
      }
    }

    // Setup image upload functionality
    function setupImageUpload() {
      const uploadInput = document.getElementById('uploadInput');
      const uploadLabel = document.getElementById('uploadLabel');
      const imagePreview = document.getElementById('imagePreview');
      const previewImg = document.getElementById('previewImg');
      const removeImageBtn = document.getElementById('removeImage');
      const changeImageBtn = document.getElementById('changeImage');

      uploadInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            previewImg.src = e.target.result;
            uploadLabel.style.display = 'none';
            imagePreview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });

      removeImageBtn.addEventListener('click', function() {
        uploadInput.value = '';
        previewImg.src = '';
        uploadLabel.style.display = 'flex';
        imagePreview.style.display = 'none';
      });

      changeImageBtn.addEventListener('click', function() {
        uploadInput.click();
      });
    }

    // Setup form event listeners
    function setupFormListeners() {
      // Budget input listener
      const budgetInput = document.getElementById('budget');
      if (budgetInput) {
        budgetInput.addEventListener('input', computeParticipantsFromBudget);
      }

      // Launch campaign button
      const launchBtn = document.getElementById('launchCampaignBtn');
      if (launchBtn) {
        launchBtn.addEventListener('click', showPopup);
      }

      // Confirmation buttons
      const cancelBtn = document.getElementById('cancelLaunchBtn');
      const confirmBtn = document.getElementById('confirmLaunchBtn');
      const closeBtn = document.getElementById('closeAllPopupsBtn');

      if (cancelBtn) cancelBtn.addEventListener('click', hidePopup);
      if (confirmBtn) confirmBtn.addEventListener('click', launchCampaign);
      if (closeBtn) closeBtn.addEventListener('click', closeAllPopups);
    }

    // Bootstrap Modal Functions
    function showPopup() {
      console.log('🚀 Showing launch campaign popup...');
      const popup = document.getElementById('popup');
      if (popup) {
        const modal = new bootstrap.Modal(popup);
        modal.show();
        console.log('✅ Bootstrap modal displayed successfully');
      } else {
        console.error('❌ Launch popup element not found');
      }
    }

    function hidePopup() {
      console.log('❌ Hiding launch campaign popup...');
      const popup = document.getElementById('popup');
      if (popup) {
        const modal = bootstrap.Modal.getInstance(popup);
        if (modal) {
          modal.hide();
        }
      }
    }

    function closeAllPopups() {
      console.log('🔄 Closing all popups...');
      
      // Hide confirmation modal
      const popup = document.getElementById('popup');
      if (popup) {
        const modal = bootstrap.Modal.getInstance(popup);
        if (modal) modal.hide();
      }
      
      // Hide success modal
      const successPopup = document.getElementById('successPopup');
      if (successPopup) {
        const modal = bootstrap.Modal.getInstance(successPopup);
        if (modal) modal.hide();
      }
      
      // Redirect back to campaigns page
      setTimeout(() => {
        console.log('🔄 Redirecting to campaigns page...');
        window.location.href = 'campaignProgress.html';
      }, 500);
    }

    // Show success popup using Bootstrap
    function showSuccessPopup() {
      console.log('🎉 Showing success popup...');
      const successPopup = document.getElementById('successPopup');
      if (successPopup) {
        const modal = new bootstrap.Modal(successPopup, {
          backdrop: 'static', // Prevent closing by clicking outside
          keyboard: false     // Prevent closing with escape key
        });
        modal.show();
        console.log('✅ Success modal displayed');
      }
    }

    // Main launch campaign function
    async function launchCampaign() {
      console.log('🚀 Launching campaign...');
      
      try {
        // Hide confirmation popup
        hidePopup();
        
        // Show loading state
        const confirmBtn = document.getElementById('confirmLaunchBtn');
        if (confirmBtn) {
          confirmBtn.disabled = true;
          confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Launching...';
        }

        // Collect form data
        const formData = await collectCampaignData();
        
        if (!formData) {
          console.error('❌ Failed to collect campaign data');
          showErrorNotification('Please fill in all required fields');
          return;
        }

        console.log('📋 Campaign data collected:', formData);

        // Check diamond balance before launching
        console.log('💎 Checking diamond balance...');
        const currentBalance = await getCurrentDiamondBalance();
        const requiredBudget = parseInt(formData.budget) || 0;
        
        console.log(`Current balance: ${currentBalance}, Required: ${requiredBudget}`);
        
        if (currentBalance < requiredBudget) {
          const shortfall = requiredBudget - currentBalance;
          showErrorNotification(`Insufficient diamonds! You need ${shortfall} more diamonds. Current balance: ${currentBalance}`);
          return;
        }

        // Get authentication token
        const token = await getValidToken();
        if (!token) {
          showErrorNotification('Please log in to launch campaign');
          return;
        }

        console.log('🌐 Submitting campaign to API...');
        
        // Submit to API
        const response = await fetch(`${API_BASE_URL}api/campaigns/upload`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(formData)
        });

        console.log('📡 API response status:', response.status);

        if (response.ok) {
          const result = await response.json();
          console.log('✅ Campaign launched successfully:', result);
          
          // Show success popup
          showSuccessPopup();
          
          // Clear form
          clearForm();
          
        } else {
          const errorText = await response.text();
          console.error('❌ Campaign launch failed:', response.status, errorText);
          
          // Try to parse error response
          let errorMessage = `Campaign launch failed: ${response.status} error`;
          try {
            const errorData = JSON.parse(errorText);
            if (errorData.message) {
              errorMessage = errorData.message;
            }
          } catch (parseError) {
            console.warn('Could not parse error response as JSON');
          }
          
          // Handle different error types
          if (response.status === 404) {
            console.warn('⚠️ API endpoint not found, using demo mode');
            showSuccessPopup(); // Show success in demo mode
          } else if (response.status === 400) {
            console.error('❌ Bad Request - Missing or invalid data:', errorMessage);
            showErrorNotification(`Validation Error: ${errorMessage}`);
          } else if (response.status === 401) {
            console.error('❌ Unauthorized - Please log in again');
            showErrorNotification('Please log in again to launch campaigns');
          } else {
            showErrorNotification(errorMessage);
          }
        }

      } catch (error) {
        console.error('💥 Error launching campaign:', error);
        showErrorNotification('Network error. Please try again.');
      } finally {
        // Reset button state
        const confirmBtn = document.getElementById('confirmLaunchBtn');
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = 'Yes, Launch';
        }
      }
    }


    // Collect all campaign data from form
    async function collectCampaignData() {
      try {
        const title = document.getElementById('campaignName')?.value?.trim();
        const description = document.getElementById('notes')?.value?.trim();
        const budget = document.getElementById('budget')?.value;
        const participants = document.getElementById('participants')?.value;
        
        console.log('📋 Form field values:', {
          title: title || 'MISSING',
          description: description || 'MISSING', 
          budget: budget || 'MISSING',
          participants: participants || 'Optional'
        });
        
        if (!title || !description || !budget) {
          console.error('❌ Missing required fields:', {
            title: !title ? 'MISSING' : 'OK',
            description: !description ? 'MISSING' : 'OK',
            budget: !budget ? 'MISSING' : 'OK'
          });
          return null;
        }

        // Collect action URLs
        const retweetUrls = Array.from(document.querySelectorAll('input[name="retweetUrl"]'))
          .map(input => input.value.trim()).filter(url => url);
        const followUrls = Array.from(document.querySelectorAll('input[name="followUrl"]'))
          .map(input => input.value.trim()).filter(url => url);
        const commentUrls = Array.from(document.querySelectorAll('input[name="commentUrl"]'))
          .map(input => input.value.trim()).filter(url => url);
        const likeUrls = Array.from(document.querySelectorAll('input[name="likeUrl"]'))
          .map(input => input.value.trim()).filter(url => url);

        // Handle campaign image
        let campaignImage = null;
        const imageInput = document.getElementById('campaignImage');
        if (imageInput.files && imageInput.files[0]) {
          try {
            campaignImage = await fileToBase64(imageInput.files[0]);
            console.log('📸 Campaign image processed:', campaignImage.substring(0, 50) + '...');
          } catch (error) {
            console.error('❌ Error processing image:', error);
          }
        }

        const campaignData = {
          title,
          description,
          budget: parseInt(budget),
          participants: participants ? parseInt(participants) : null,
          assets: campaignImage ? [{ data: campaignImage, type: 'image' }] : [],
          actions: {
            retweet: retweetUrls,
            follow: followUrls,
            comment: commentUrls,
            like: likeUrls
          },
          status: 'pending',
          start_date: new Date().toISOString(),
          end_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 days from now
          created_at: new Date().toISOString()
        };

        return campaignData;
      } catch (error) {
        console.error('💥 Error collecting campaign data:', error);
        return null;
      }
    }

    // Clear form after successful submission
    function clearForm() {
      console.log('🧹 Clearing form...');
      
      const titleInput = document.getElementById('campaignName');
      const descInput = document.getElementById('notes');
      const budgetInput = document.getElementById('budget');
      const participantsInput = document.getElementById('participants');
      
      if (titleInput) titleInput.value = '';
      if (descInput) descInput.value = '';
      if (budgetInput) budgetInput.value = '';
      if (participantsInput) participantsInput.value = '';
      
      // Clear action URL inputs
      document.querySelectorAll('input[name*="Url"]').forEach(input => {
        input.value = '';
      });
      
      console.log('✅ Form cleared successfully');
    }

    // Show error notification
    function showErrorNotification(message) {
      console.error('🔴 Error:', message);
      
      // Create or update notification
      let notification = document.getElementById('errorNotification');
      if (!notification) {
        notification = document.createElement('div');
        notification.id = 'errorNotification';
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #ef4444;
          color: white;
          padding: 15px 20px;
          border-radius: 8px;
          z-index: 10000;
          max-width: 400px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(notification);
      }
      
      notification.textContent = message;
      notification.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        if (notification) {
          notification.style.display = 'none';
        }
      }, 5000);
    }

    // Test function for debugging
    window.testLaunchCampaign = function() {
      console.log('🧪 Testing launch campaign...');
      showPopup();
    };

    window.debugCampaignForm = function() {
      console.log('🔍 Debugging campaign form...');
      
      // Check if form fields exist
      const fields = {
        campaignName: document.getElementById('campaignName'),
        notes: document.getElementById('notes'),
        budget: document.getElementById('budget'),
        participants: document.getElementById('participants')
      };
      
      console.log('📋 Form field elements:', fields);
      
      Object.entries(fields).forEach(([name, element]) => {
        if (element) {
          console.log(`✅ ${name}: "${element.value}" (${element.value ? 'filled' : 'empty'})`);
        } else {
          console.error(`❌ ${name}: Element not found!`);
        }
      });
      
      const data = collectCampaignData();
      console.log('📊 Collected data:', data);
      
      if (data) {
        console.log('📋 Campaign data structure:');
        console.log('  - Title:', data.title);
        console.log('  - Description:', data.description);
        console.log('  - Budget:', data.budget);
        console.log('  - Participants:', data.participants);
        console.log('  - Start Date:', data.start_date);
        console.log('  - End Date:', data.end_date);
        console.log('  - Actions:', data.actions);
        console.log('  - Status:', data.status);
      }
      
      return data;
    };

    // Test function to fill form with sample data
    window.fillSampleData = function() {
      console.log('🧪 Filling form with sample data...');
      
      const campaignName = document.getElementById('campaignName');
      const notes = document.getElementById('notes');
      const budget = document.getElementById('budget');
      const participants = document.getElementById('participants');
      
      if (campaignName) campaignName.value = 'Test Campaign';
      if (notes) notes.value = 'This is a test campaign for engagement';
      if (budget) budget.value = '100';
      if (participants) participants.value = '50';
      
      console.log('✅ Sample data filled');
    };

  </script>
</body>
</html>
